C251 COMPILER V5.60.0,  main                                                               27/02/24  23:09:54  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE main
OBJECT MODULE PLACED IN .\Out_File\main.obj
COMPILER INVOKED BY: D:\keil5\keil5_MDK\keil5_MDK_32\C251\BIN\C251.EXE ..\USER\src\main.c XSMALL INTR2 WARNINGLEVEL(3) B
                    -ROWSE INCDIR(..\..\Libraries\libraries;..\..\Libraries\seekfree_libraries;..\..\Libraries\seekfree_peripheral;..\CODE;..
                    -\USER\inc;..\USER\src) DEBUG PRINT(.\Out_File\main.lst) OBJECT(.\Out_File\main.obj) 

stmt  level    source

    1          #include "headfile.h"
    2          #include "Motor.h"
    3          #include "ADC.h"
    4          #include "MPU6050.h"
    5          #include "Element.h"
    6          #include "ADC.h"
    7          #include "math.h"
    8          #include "TOF.h"
    9          
   10          short gx, gy, gz;
   11          char Isr_flag_20 = 0; //ÔøΩ–∂ÔøΩ2ÔøΩŒ¥ÔøΩÔøΩÔøΩ
   12          char Isr_flag_10 = 0; 
   13          
   14          float KeyAdjust = 0;
   15          
   16          float Diff,Plus; // ÔøΩÔøΩ / ÔøΩÔøΩ
   17          float Ratio = 0;
   18          
   19          float Diff_Mid,Plus_Mid; // ÔøΩÔøΩ / ÔøΩÔøΩ
   20          float Ratio_Mid = 0;
   21          float sum;
   22          int dis = 2000;
   23          
   24          float Exp_Speed_L = 0;
   25          float Exp_Speed_R = 0;
   26          float Exp_Speed = 200;
   27          
   28          extern uint16 vl53l0x_distance_mm;
   29          extern uint8 vl53l0x_finsh_flag;
   30          
   31          void Init_all(void)
   32          {
   33   1              WTST = 0;                                               //ÔøΩÔøΩÔøΩ√≥ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ»¥ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ÷µŒ™0ÔøΩ…ΩÔøΩCPU÷¥ÔøΩ–≥ÔøΩÔøΩ
             -ÔøΩÔøΩÔøΩŸ∂ÔøΩÔøΩÔøΩÔøΩÔøΩŒ™ÔøΩÔøΩÔøΩ  
   34   1              DisableGlobalIRQ();                             //ÔøΩÿ±ÔøΩÔøΩÔøΩÔøΩ–∂ÔøΩ
   35   1              sys_clk = 35000000;                             //ÔøΩÔøΩÔøΩÔøΩœµÕ≥∆µÔøΩÔøΩŒ™35MHz
   36   1      
   37   1      //ÔøΩÔøΩ ºÔøΩÔøΩÔøΩƒ¥ÔøΩÔøΩÔøΩ
   38   1              board_init();                                   
   39   1      
   40   1      ////ÁºñÁ†ÅÂô®ÊñπÂêëÂºïËÑöÂàùÂßãÂåñ
   41   1              gpio_mode(P5_3, GPIO);          
   42   1              gpio_mode(P3_5, GPIO);          
   43   1      
   44   1      //ÊåâÈîÆÂàùÂßãÂåñ
   45   1              gpio_mode(P7_0, GPIO); //KEY1
   46   1              gpio_mode(P7_1, GPIO); //KEY2
   47   1              
   48   1      ////ÊµãË∑ùÊ®°ÂùóÂàùÂßãÂåñ
   49   1              //gpio_mode(P3_2, GPIO);
   50   1              vl53l0x_init();
   51   1              
   52   1      ////OLEDÂàùÂßãÂåñ
   53   1              oled_init();                                    
   54   1              
   55   1      ////MPU6050ÂàùÂßãÂåñ
   56   1              MPU6050_DMP_Init();     
C251 COMPILER V5.60.0,  main                                                               27/02/24  23:09:54  PAGE 2   

   57   1      //      
   58   1      ////ÂÆöÊó∂Âô®ÂàùÂßãÂåñ
   59   1              pit_timer_ms(TIM_4, 10);                //10msÂÆöÊó∂Âô®
   60   1      //      
   61   1      ////ÁºñÁ†ÅÂô®ÂàùÂßãÂåñ
   62   1              ctimer_count_init(CTIM0_P34);   //ÁºñÁ†ÅÂô®1ËÆ°Êï∞
   63   1              ctimer_count_init(CTIM3_P04);   //ÁºñÁ†ÅÂô®2ËÆ°Êï∞
   64   1              
   65   1      ////‰∏≤Âè£ÂàùÂßãÂåñ
   66   1      //      uart_init(UART_1, UART1_RX_P30, UART1_TX_P31, 115200, TIM_2);
   67   1              
   68   1      ////ÁîµÊú∫ÂàùÂßãÂåñ
   69   1              Motor_Init();
   70   1              
   71   1      ////ËúÇÈ∏£Âô®ÂàùÂßãÂåñ
   72   1              pwm_init(PWMB_CH4_P77,100,0);
   73   1              
   74   1      ////ÂàùÂßãÂåñÊâÄÊúâADÂºïËÑö
   75   1              ADC_InitAll(); 
   76   1              
   77   1      ////pidÂàùÂßãÂåñ  PID_Init(ÁªìÊûÑ‰Ωì, KP, KI, KD, ËæìÂá∫ÈôêÂπÖÔºåÁßØÂàÜÈôêÂπÖ)
   78   1              PID_Init(&Left_Wheel_PID , 20, 0.5, 0, 10000, 2000);
   79   1              PID_Init(&Right_Wheel_PID, 20, 0.5, 0, 10000, 2000);
   80   1              PID_Init(&Turn_PID , -2, 0, 0 ,10000, 0);
   81   1      } 
   82          
   83          //ÂØπADCÂÄºËøõË°åÂ§ÑÁêÜÂæóÂà∞Â∑ÆÊØîÂíå
   84          void Get_Ratio(void)
   85          {
   86   1              sum = ADC_proc[0]+ ADC_proc[1]+ADC_proc[2]+ADC_proc[3];
   87   1      //      sum_L = sqrt((ADC_proc[0]*ADC_proc[0]+ADC_proc[1]*ADC_proc[1]));
   88   1      //      sum_R = sqrt((ADC_proc[2]*ADC_proc[2]+ADC_proc[3]*ADC_proc[3]));
   89   1      
   90   1              Diff = ADC_proc[0] - ADC_proc[3];
   91   1              Plus = ADC_proc[0] + ADC_proc[3];
   92   1              
   93   1              Diff_Mid = ADC_proc[1] - ADC_proc[2];
   94   1              Plus_Mid = ADC_proc[1] + ADC_proc[2];
   95   1              
   96   1      //      if(sum > 35)  //ËæπÁïå‰øùÊä§
   97   1      //      {
   98   1                      Ratio = Diff/Plus;
   99   1                      Ratio_Mid = Diff_Mid/Plus_Mid;
  100   1                      if(Plus_Mid > 30 && Plus_Mid < 65)
  101   1                      {
  102   2                              Ratio = Ratio_Mid;
  103   2                      }
  104   1      //      }
  105   1      
  106   1      }
  107          
  108          void main(void) 
  109          {
  110   1              Init_all();
  111   1              EnableGlobalIRQ();      //ÔøΩÔøΩÔøΩ–∂ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ
  112   1              KeyAdjust = -180;
  113   1              while(1)
  114   1              {
  115   2                      oled_printf_float(0,0,ADC_proc[0],5,2);
  116   2                      oled_printf_float(0,2,ADC_proc[1],5,2);
  117   2                      oled_printf_float(0,4,ADC_proc[2],5,2);
  118   2                      oled_printf_float(0,6,ADC_proc[3],5,2);
  119   2                      
  120   2                      oled_printf_float(60,0,vl53l0x_distance_mm,5,2);
  121   2                      oled_printf_float(60,2,Ratio,1,2);
  122   2      //              printf("%.2f,%.2f,%.2f,%.2f,%.2f\r\n",Exp_Speed_L,Exp_Speed_R,Speed_L,Speed_R,Turn_PID.PID_Out*0.09);
C251 COMPILER V5.60.0,  main                                                               27/02/24  23:09:54  PAGE 3   

  123   2      //              printf("%.2f,%.2f,%.2f,%.2f,%.2f,%.2f\r\n",ADC_proc[0],ADC_proc[1],Sum_Angle,sum_L,sum_R,Ratio);
  124   2                      
  125   2                      //////////////////////////////////‰ΩøÁî®ÊåâÈîÆË∞ÉÂèÇÔºåÊöÇÊó∂Âè™ÂàùÂßãÂåñ‰∏§‰∏™ÊåâÈîÆ//////////////////
             -/////////////// 
  126   2                      if(P70 == 0)
  127   2                      {
  128   3                              while(P70 == 0);
  129   3                              KeyAdjust += 2;
  130   3                      }
  131   2                      if(P71 == 0)
  132   2                      {
  133   3                              while(P71 == 0);
  134   3                              KeyAdjust -= 2;
  135   3                      }
  136   2                      
  137   2                      if(Isr_flag_10 == 1)
  138   2                      {
  139   3                              ADC_GetValue();
  140   3                              MPU6050_Refresh_DMP();
  141   3                              MPU_Get_Gyroscope(&gx, &gy, &gz);
  142   3                              Get_Ratio();
  143   3                              
  144   3                              ///////////////////////////////// Áõ¥ÈÅìÂºØÈÅìÂà§Âà´ ///////////////////////////////// 
  145   3                              if(Ratio >= -0.1 && Ratio <= 0.1) //Áõ¥Á∫ø
  146   3                              {
  147   4                                      Turn_PID.Kp = -15;
  148   4                                      Turn_PID.Kd = -2.6;
  149   4                                      Left_Wheel_PID.Kp = Right_Wheel_PID.Kp = 20;
  150   4                                      Left_Wheel_PID.Ki = Right_Wheel_PID.Ki = 0.5;
  151   4                                      Exp_Speed = 260;
  152   4                              }
  153   3                              else   // ÂºØÈÅì
  154   3                              {
  155   4                                      Turn_PID.Kp = -138;
  156   4                                      Turn_PID.Kd = -24.3;
  157   4                                      Left_Wheel_PID.Kp = Right_Wheel_PID.Kp = 36;
  158   4                                      Left_Wheel_PID.Ki = Right_Wheel_PID.Ki = 0.9; //iÂ§™Â§ß‰ºöÂá∫Áé∞Áü´Ê≠£ÊªûÂêéÔºåÂØºËá¥ËΩ¶ÂèçÊñπÂêëÈ£òÈ
             -Ä∏
  159   4                                      Exp_Speed = 200;
  160   4                              }
  161   3                              
  162   3                              ///////////////////////////////// ÈÅøÂºÄË∑ØÈöú //////////////////////////////////////////                       
  163   3                              if(Barrier_Flag4 == 0) //ÈÅøÈöúÂè™ËøêË°å‰∏ÄÊ¨°
  164   3                              {
  165   4                                      vl53l0x_get_distance();
  166   4                                      if(vl53l0x_finsh_flag)  //ÊµãÈáèÂÆåÊàê
  167   4                                      {
  168   5                                              if (vl53l0x_distance_mm < 600)          //      Ê£ÄÊµãÂà∞Ë∑ØÈöú
  169   5                                              {
  170   6                                                      Barrier_Flag1 = 1;
  171   6                                              }
  172   5                                      }
  173   4                                      Elem_Barrier(gz);
  174   4                              }
  175   3                              
  176   3                              ////////////////////////////////// ÂúÜÁéØÂà§Âà´ ///////////////////////////////////////////////
  177   3                              if(ADC_proc[2] > 75 && (ADC_proc[3] > 8 || ADC_proc[1] > 8))    //‰∏≠Èó¥Ê®™ÁîµÊÑüËØÜÂà´ÂúÜÁéØ
  178   3                              {
  179   4                                      if(ADC_proc[3] > ADC_proc[1])  //Âà§Êñ≠Â∑¶Âè≥
  180   4                                      {
  181   5                                              circle_flag_R = 1;
  182   5                                              Elem_Circle_R((Speed_L + Speed_R)/2,gz);        
  183   5                                      }
  184   4                                      else if(ADC_proc[3] < ADC_proc[1]) 
  185   4                                      {
  186   5                                              circle_flag_L = 1;
C251 COMPILER V5.60.0,  main                                                               27/02/24  23:09:54  PAGE 4   

  187   5                                              Elem_Circle_L((Speed_L + Speed_R)/2,gz);
  188   5                                      }
  189   4                              }
  190   3                                      
  191   3                              ///////////////////////////// ËΩ¨ÂêëÁéØËÆ°ÁÆó //////////////////////////////////////////////////                                
  192   3                              PID_Calculate(&Turn_PID,Ratio*100,gz/100); 
  193   3                              Limit_Out(&Turn_PID.PID_Out,-2000,5000);
  194   3                                      
  195   3                              ////////////////////////////////‰∏ä‰∏ãÂù°ÈÅì ////////////////////////////////////////////////////
  196   3                              Elem_Up_Down(Pitch,gy);         
  197   3                                      
  198   3                              ///////////////////////////// ÁâπÊÆäÂÖÉÁ¥†ÈôçÈÄü ///////////////////////////////////////////////////
  199   3                              if( circle_flag_L == 1 || circle_flag_R == 1 || Barrier_Flag2 == 1 || Barrier_Flag1 == 1)  
  200   3                                      Exp_Speed = 160;
  201   3                              Exp_Speed_L = Exp_Speed + Turn_PID.PID_Out*0.09;
  202   3                              Exp_Speed_R = Exp_Speed - Turn_PID.PID_Out*0.09;
  203   3                              
  204   3                              Get_Speed();  //Ëé∑ÂèñËΩ¶ÈÄü
  205   3      
  206   3                              PID_Calculate(&Left_Wheel_PID,Exp_Speed_L,Speed_L);//ÈÄüÂ∫¶ÁéØPIDËÆ°ÁÆó
  207   3                              PID_Calculate(&Right_Wheel_PID,Exp_Speed_R,Speed_R);
  208   3                              
  209   3                              //////////////////////// // È©∂Á¶ªËµõÈÅìÔºåÂÅúËΩ¶ /////////////////////////////////////////////////
  210   3                              if(ADC_proc[2]<5 && Barrier_Executed == 1) 
  211   3                              {
  212   4                                      Left_Wheel_PID.PID_Out = 0;
  213   4                                      Right_Wheel_PID.PID_Out = 0;
  214   4                              }
  215   3                              
  216   3              //                      Left_SetSpeed(Left_Wheel_PID.PID_Out);
  217   3              //                      Right_SetSpeed(Right_Wheel_PID.PID_Out);
  218   3                              
  219   3                              Left_SetSpeed(2000);
  220   3                              Right_SetSpeed(-2000);
  221   3                              Isr_flag_10 = 0;
  222   3                      } 
  223   2              }
  224   1      }
  225          
  226          
  227          


Module Information          Static   Overlayable
------------------------------------------------
  code size            =      1283     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =        54     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =        64     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
